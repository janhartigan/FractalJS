(function(){function e(h,g){this.real=h;this.imaginary=g}e.prototype={real:0,imaginary:0,add:function(){if(arguments.length==1){return new e(this.real+arguments[0].real,this.imaginary+arguments[0].imaginary)}else{return new e(this.real+arguments[0],this.imaginary+arguments[1])}},sub:function(){if(arguments.length==1){return new e(this.real-arguments[0].real,this.imaginary-arguments[0].imaginary)}else{return new e(this.real-arguments[0],this.imaginary-arguments[1])}},mult:function(){var g=arguments[0];if(arguments.length!=1){g=new e(arguments[0],arguments[1])}return new e(this.real*g.real-this.imaginary*g.imaginary,this.real*g.imaginary+this.imaginary*g.real)},mod:function(){return Math.sqrt(this.real*this.real+this.imaginary*this.imaginary)},toString:function(){return this.real+"+"+this.imaginary+"i"}};var c=[];function d(h,g){return this.init(h,g)}d.prototype={canvas:null,ctx:null,width:0,height:0,zoom:{x:-2.3,y:1.5,width:3,height:3},image:null,workers:null,generation:0,currentRow:0,rowsCompleted:0,options:{useControlBar:true,maxIterations:300,escapeValue:4,colorRangeRepeats:7,width:0,height:0,useWorkers:true,workerPath:"fractaljs.worker.js",numWorkers:10,afterDraw:function(g){}},init:function(k,j){var g=this,h;if(!k.getContext){return false}if(j){for(h in this.options){if(j[h]!==undefined){this.options[h]=j[h]}}}this.canvas=k;this.ctx=k.getContext("2d");if(this.options.width){this.canvas.width=this.options.width}if(this.options.height){this.canvas.height=this.options.height}this.width=this.canvas.width;this.height=this.canvas.height;if(!!window.Worker&&this.options.useWorkers){this.workers=[];for(var l=0;l<this.options.numWorkers;l++){var o=new Worker(this.options.workerPath);o.onmessage=function(i){g.receiveRow(i)};o.idle=true;this.workers.push(o)}}this.drawFractal();if(this.options.useControlBar){this.buildControlBar()}this.canvas.style.position="relative";this.canvas.onclick=function(p){var i,r,q;if(p.offsetX){i=p.offsetX;r=p.offsetY}else{if(p.layerX){i=p.layerX;r=p.layerY}}q=g.convertPixelToPoint(i,r);g.zoom.x=q.real-(g.zoom.width/2);g.zoom.y=q.imaginary+(g.zoom.height/2);g.drawFractal()};return true},establishImageData:function(){if(this.ctx.createImageData){this.image=this.ctx.createImageData(this.width,this.height)}else{if(this.ctx.getImageData){this.image=this.ctx.getImageData(0,0,this.width,this.height)}else{this.image={width:this.width,height:this.height,data:new Array(this.width*this.height*4)}}}},drawFractal:function(){var k=new e(0,0),q=k,p,j,h=0,r,u,s,g,l=false,v=this.options.maxIterations/this.options.colorRangeRepeats,o=this.zoom.height;this.width=this.canvas.width;this.height=this.canvas.height;this.establishImageData();this.zoom.height=this.zoom.width*(this.height/this.width);this.zoom.y=this.zoom.y-(o-this.zoom.height)/2;this.generation++;this.currentRow=0;this.rowsCompleted=0;if(this.workers){for(var j=0;j<this.options.numWorkers;j++){if(this.workers[j].idle){this.processRow(this.workers[j])}}return true}for(r=0;r<this.height;r++){for(u=0;u<this.width;u++){q=k;p=this.convertPixelToPoint(u,r);j=0;l=false;while(q.mod()<this.options.escapeValue&&!l){q=q.mult(q).add(p);j++;if(j>this.options.maxIterations){j=0;this.image.data[h]=0;this.image.data[h+1]=0;this.image.data[h+2]=0;this.image.data[h+3]=255;h+=4;l=true}}if(!l){s=(Math.log(Math.log(Math.sqrt(Math.pow(q.real,2)+Math.pow(q.imaginary,2)))/Math.log(2))/Math.log(2));g=this.rainbowColor((j-s)/v);this.image.data[h]=g.r;this.image.data[h+1]=g.g;this.image.data[h+2]=g.b;this.image.data[h+3]=255;h+=4}}}this.ctx.putImageData(this.image,0,0);this.options.afterDraw.call(this.canvas,this.zoom)},processRow:function(h){var g=this.currentRow++;if(g>=this.height){h.idle=true}else{h.idle=false;h.postMessage({row:g,width:this.width,height:this.height,zoom:this.zoom,generation:this.generation,maxIterations:this.options.maxIterations,colorRangeRepeats:this.options.colorRangeRepeats,escapeValue:this.options.escapeValue})}},receiveRow:function(l){var o=l.target,k=l.data,j=l.data.imageData.length,g=0,h=k.row*j;if(k.generation==this.generation){for(g=0;g<j;g++){this.image.data[g+h]=k.imageData[g]}this.rowsCompleted++;if(this.rowsCompleted==this.height){this.ctx.putImageData(this.image,0,0)}}this.processRow(o)},convertPixelToPoint:function(g,j){var i=this.zoom.width/(this.width*1),h=this.zoom.height/(this.height*1);return new e(this.zoom.x+g*i,this.zoom.y-j*h)},rainbowColor:function(g){var j=[],i=6,h=parseInt(g);positionFrac=g-h;m=i*positionFrac,n=parseInt(m),f=m-n,t=parseInt(f*255);switch(n){case 0:j.r=255;j.g=t;j.b=0;break;case 1:j.r=255-t;j.g=255;j.b=0;break;case 2:j.r=0;j.g=255;j.b=t;break;case 3:j.r=0;j.g=255-t;j.b=255;break;case 4:j.r=t;j.g=0;j.b=255;break;case 5:j.r=255;j.g=0;j.b=255-t;break}return j},buildControlBar:function(){var i=document.createElement("div"),h='<input type="button" name="zoomin" value="zoom in" /><input type="button" name="zoomout" value="zoom out" />',g=this;i.className="fractaljs-control-bar";i.style.width=this.width+"px";i.innerHTML=h;this.canvas.parentNode.insertBefore(i,this.canvas.nextSibling);i.childNodes[0].onclick=function(){g.zoom.x+=g.zoom.width/4;g.zoom.y-=g.zoom.height/4;g.zoom.width/=2;g.zoom.height/=2;g.drawFractal()};i.childNodes[1].onclick=function(){g.zoom.x-=g.zoom.width/2;g.zoom.y+=g.zoom.height/2;g.zoom.width*=2;g.zoom.height*=2;g.drawFractal()}},destroy:function(){this.ctx.clearRect(0,0,this.width,this.height)}};function b(i){var g=false,h;for(h in c){if(i==c[h].canvas){g=c[h];break}}return g}function a(){}a.prototype={create:function(i,h){var g=false,j;if(i.nodeName!="CANVAS"){return false}g=b(i);if(g){if(h){if(h){for(name in g.options){if(h[name]!==undefined){g.options[name]=h[name]}}}}g.drawFractal();return i}j=new d(i,h);if(j){c.push(j);return i}else{return false}},getFractalObject:function(g){return b(g)},destroy:function(h){var g;for(g in c){if(h==c[g].canvas){c[g].destroy();c.splice(g,1);return true}}return false}};window.fractaljs=new a()})();