(function(c){function d(g,e){this.real=g;this.imaginary=e}d.prototype={real:0,imaginary:0,add:function(){if(arguments.length==1){return new d(this.real+arguments[0].real,this.imaginary+arguments[0].imaginary)}else{return new d(this.real+arguments[0],this.imaginary+arguments[1])}},sub:function(){if(arguments.length==1){return new d(this.real-arguments[0].real,this.imaginary-arguments[0].imaginary)}else{return new d(this.real-arguments[0],this.imaginary-arguments[1])}},mult:function(){var e=arguments[0];if(arguments.length!=1){e=new d(arguments[0],arguments[1])}return new d(this.real*e.real-this.imaginary*e.imaginary,this.real*e.imaginary+this.imaginary*e.real)},modSquared:function(){return this.real*this.real+this.imaginary*this.imaginary},toString:function(){return this.real+"+"+this.imaginary+"i"}};var a=[];function b(g,e){return this.init(g,e)}b.prototype={canvas:null,$canvas:null,ctx:null,width:0,height:0,zoom:{x:-2.3,y:1.5,width:3,height:3},image:null,options:{useControlBar:true,maxIterations:300,colorRangeRepeats:7,width:0,height:0,afterDraw:function(e){}},init:function(h,g){var e=this;if(!h.getContext){return false}if(g){c.extend(this.options,g)}this.canvas=h;this.$canvas=c(h);this.ctx=h.getContext("2d");if(this.options.width){this.$canvas.attr("width",this.options.width)}if(this.options.height){this.$canvas.attr("height",this.options.height)}this.width=h.width;this.height=h.height;this.zoom.height=this.zoom.width*(this.height/this.width);if(this.ctx.createImageData){this.image=this.ctx.createImageData(this.width,this.height)}else{if(this.ctx.getImageData){this.image=this.ctx.getImageData(0,0,this.width,this.height)}else{this.image={width:this.width,height:this.height,data:new Array(this.width*this.height*4)}}}this.drawFractal();if(this.options.useControlBar){this.buildControlBar()}this.$canvas.click(function(j){var k=c(this).offset(),i=j.pageX-k.left,p=j.pageY-k.top,l=e.convertPixelToPoint(i,p);e.zoom.x=l.real-(e.zoom.width/2);e.zoom.y=l.imaginary+(e.zoom.height/2);e.drawFractal()});return true},drawFractal:function(){var j=new d(0,0),o=j,l,h,g=0,p,r,q,e,k=false,s=this.options.maxIterations/this.options.colorRangeRepeats;this.width=this.canvas.width;this.height=this.canvas.height;for(p=0;p<this.height;p++){for(r=0;r<this.width;r++){o=j;l=this.convertPixelToPoint(r,p);h=0;k=false;while(o.modSquared()<4&&!k){o=o.mult(o).add(l);h++;if(h>this.options.maxIterations){h=0;this.image.data[g]=0;this.image.data[g+1]=0;this.image.data[g+2]=0;this.image.data[g+3]=255;g+=4;k=true}}if(!k){q=(Math.log(Math.log(Math.sqrt(Math.pow(o.real,2)+Math.pow(o.imaginary,2)))/Math.log(2))/Math.log(2));e=this.rainbowColor((h-q)/s);this.image.data[g]=e.r;this.image.data[g+1]=e.g;this.image.data[g+2]=e.b;this.image.data[g+3]=255;g+=4}}}this.ctx.putImageData(this.image,0,0);this.options.afterDraw.call(this.$canvas,this.zoom)},convertPixelToPoint:function(e,i){var h=this.zoom.width/(this.width*1),g=this.zoom.height/(this.height*1);return new d(this.zoom.x+e*h,this.zoom.y-i*g)},rainbowColor:function(e){var i=[],h=6,g=parseInt(e);positionFrac=e-g;m=h*positionFrac,n=parseInt(m),f=m-n,t=parseInt(f*255);switch(n){case 0:i.r=255;i.g=t;i.b=0;break;case 1:i.r=255-t;i.g=255;i.b=0;break;case 2:i.r=0;i.g=255;i.b=t;break;case 3:i.r=0;i.g=255-t;i.b=255;break;case 4:i.r=t;i.g=0;i.b=255;break;case 5:i.r=255;i.g=0;i.b=255-5;break}return i},buildControlBar:function(){var g='<div class="fractaljs-control-bar" style="width:'+this.width+'px"><input type="button" name="zoomin" value="zoom in" /><input type="button" name="zoomout" value="zoom out" /></div>',h,e=this;this.$canvas.after(g);h=this.$canvas.next(".fractaljs-control-bar");h.find("input[name=zoomin]").click(function(){e.zoom.x+=e.zoom.width/4;e.zoom.y-=e.zoom.height/4;e.zoom.width/=2;e.zoom.height/=2;e.drawFractal()});h.find("input[name=zoomout]").click(function(){e.zoom.x-=e.zoom.width/2;e.zoom.y+=e.zoom.height/2;e.zoom.width*=2;e.zoom.height*=2;e.drawFractal()})},destroy:function(){this.ctx.clearRect(0,0,this.width,this.height)}};c.fn.fractaljs=function(e){return this.each(function(){if(this.nodeName!="CANVAS"){return true}var g=new b(this,e);if(g){a.push(g)}})};c.fn.fractaljsObject=function(){var e=false;this.each(function(){var g=this;c.each(a,function(){if(g==this.canvas){e=this;return false}})});return e};c.fn.destroyFractalJS=function(){return this.each(function(){var e=this;c.each(a,function(h,g){if(e==this.canvas){this.destroy();a.splice(h,1);return false}})})}})(jQuery);