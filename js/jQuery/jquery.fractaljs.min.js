(function(d){function e(h,g){this.real=h;this.imaginary=g}e.prototype={real:0,imaginary:0,add:function(){if(arguments.length==1){return new e(this.real+arguments[0].real,this.imaginary+arguments[0].imaginary)}else{return new e(this.real+arguments[0],this.imaginary+arguments[1])}},sub:function(){if(arguments.length==1){return new e(this.real-arguments[0].real,this.imaginary-arguments[0].imaginary)}else{return new e(this.real-arguments[0],this.imaginary-arguments[1])}},mult:function(){var g=arguments[0];if(arguments.length!=1){g=new e(arguments[0],arguments[1])}return new e(this.real*g.real-this.imaginary*g.imaginary,this.real*g.imaginary+this.imaginary*g.real)},mod:function(){return Math.sqrt(this.real*this.real+this.imaginary*this.imaginary)},toString:function(){return this.real+"+"+this.imaginary+"i"}};var b=[];function c(h,g){return this.init(h,g)}c.prototype={canvas:null,$canvas:null,ctx:null,width:0,height:0,zoom:{x:-2.3,y:1.5,width:3,height:3},image:null,workers:null,generation:0,currentRow:0,rowsCompleted:0,options:{useControlBar:true,maxIterations:300,escapeValue:4,colorRangeRepeats:7,width:0,height:0,useWorkers:true,workerPath:"fractaljs.worker.js",numWorkers:10,afterDraw:function(g){}},init:function(j,h){var g=this;if(!j.getContext){return false}if(h){d.extend(this.options,h)}this.canvas=j;this.$canvas=d(j);this.ctx=j.getContext("2d");if(this.options.width){this.$canvas.attr("width",this.options.width)}if(this.options.height){this.$canvas.attr("height",this.options.height)}this.width=j.width;this.height=j.height;if(!!window.Worker&&this.options.useWorkers){this.workers=[];for(var k=0;k<this.options.numWorkers;k++){var l=new Worker(this.options.workerPath);l.onmessage=function(i){g.receiveRow(i)};l.idle=true;this.workers.push(l)}}this.drawFractal();if(this.options.useControlBar){this.buildControlBar()}this.$canvas.click(function(p){var q=d(this).offset(),i=p.pageX-q.left,s=p.pageY-q.top,r=g.convertPixelToPoint(i,s);g.zoom.x=r.real-(g.zoom.width/2);g.zoom.y=r.imaginary+(g.zoom.height/2);g.drawFractal()});return true},establishImageData:function(){if(this.ctx.createImageData){this.image=this.ctx.createImageData(this.width,this.height)}else{if(this.ctx.getImageData){this.image=this.ctx.getImageData(0,0,this.width,this.height)}else{this.image={width:this.width,height:this.height,data:new Array(this.width*this.height*4)}}}},drawFractal:function(){var k=new e(0,0),q=k,p,j,h=0,r,u,s,g,l=false,v=this.options.maxIterations/this.options.colorRangeRepeats,o=this.zoom.height;this.width=this.canvas.width;this.height=this.canvas.height;this.establishImageData();this.zoom.height=this.zoom.width*(this.height/this.width);this.zoom.y=this.zoom.y-(o-this.zoom.height)/2;this.generation++;this.currentRow=0;this.rowsCompleted=0;if(this.workers){for(var j=0;j<this.options.numWorkers;j++){if(this.workers[j].idle){this.processRow(this.workers[j])}}return true}for(r=0;r<this.height;r++){for(u=0;u<this.width;u++){q=k;p=this.convertPixelToPoint(u,r);j=0;l=false;while(q.mod()<this.options.escapeValue&&!l){q=q.mult(q).add(p);j++;if(j>this.options.maxIterations){j=0;this.image.data[h]=0;this.image.data[h+1]=0;this.image.data[h+2]=0;this.image.data[h+3]=255;h+=4;l=true}}if(!l){s=(Math.log(Math.log(Math.sqrt(Math.pow(q.real,2)+Math.pow(q.imaginary,2)))/Math.log(2))/Math.log(2));g=this.rainbowColor((j-s)/v);this.image.data[h]=g.r;this.image.data[h+1]=g.g;this.image.data[h+2]=g.b;this.image.data[h+3]=255;h+=4}}}this.ctx.putImageData(this.image,0,0);this.options.afterDraw.call(this.$canvas,this.zoom)},processRow:function(h){var g=this.currentRow++;if(g>=this.height){h.idle=true}else{h.idle=false;h.postMessage({row:g,width:this.width,height:this.height,zoom:this.zoom,generation:this.generation,maxIterations:this.options.maxIterations,colorRangeRepeats:this.options.colorRangeRepeats,escapeValue:this.options.escapeValue})}},receiveRow:function(l){var o=l.target,k=l.data,j=l.data.imageData.length,g=0,h=k.row*j;console.log(k);if(k.generation==this.generation){for(g=0;g<j;g++){this.image.data[g+h]=k.imageData[g]}this.rowsCompleted++;if(this.rowsCompleted==this.height){this.ctx.putImageData(this.image,0,0)}}this.processRow(o)},convertPixelToPoint:function(g,j){var i=this.zoom.width/(this.width*1),h=this.zoom.height/(this.height*1);return new e(this.zoom.x+g*i,this.zoom.y-j*h)},rainbowColor:function(g){var j=[],i=6,h=parseInt(g);positionFrac=g-h;m=i*positionFrac,n=parseInt(m),f=m-n,t=parseInt(f*255);switch(n){case 0:j.r=255;j.g=t;j.b=0;break;case 1:j.r=255-t;j.g=255;j.b=0;break;case 2:j.r=0;j.g=255;j.b=t;break;case 3:j.r=0;j.g=255-t;j.b=255;break;case 4:j.r=t;j.g=0;j.b=255;break;case 5:j.r=255;j.g=0;j.b=255-t;break}return j},buildControlBar:function(){var h='<div class="fractaljs-control-bar" style="width:'+this.width+'px"><input type="button" name="zoomin" value="zoom in" /><input type="button" name="zoomout" value="zoom out" /></div>',i,g=this;this.$canvas.after(h);i=this.$canvas.next(".fractaljs-control-bar");i.find("input[name=zoomin]").click(function(){g.zoom.x+=g.zoom.width/4;g.zoom.y-=g.zoom.height/4;g.zoom.width/=2;g.zoom.height/=2;g.drawFractal()});i.find("input[name=zoomout]").click(function(){g.zoom.x-=g.zoom.width/2;g.zoom.y+=g.zoom.height/2;g.zoom.width*=2;g.zoom.height*=2;g.drawFractal()})},destroy:function(){this.ctx.clearRect(0,0,this.width,this.height)}};function a(h){var g=false;d.each(b,function(j,i){if(h==this.canvas){g=this;return false}});return g}d.fn.fractaljs=function(g){return this.each(function(){var i=this,h=false;if(this.nodeName!="CANVAS"){return true}h=a(i);if(h){d.extend(h.options,g);h.drawFractal();return true}var j=new c(this,g);if(j){b.push(j)}})};d.fn.fractaljsObject=function(){var g=false;this.each(function(){var h=this;d.each(b,function(){if(h==this.canvas){g=this;return false}})});return g};d.fn.fractaljsDestroy=function(){return this.each(function(){var g=this;d.each(b,function(i,h){if(g==this.canvas){this.destroy();b.splice(i,1);return false}})})}})(jQuery);